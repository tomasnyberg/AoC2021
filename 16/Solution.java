import java.io.BufferedReader;
import java.io.FileReader;
import java.util.*;
import java.math.BigInteger;

public class Solution {
    public static String[] exampleStrings = {
        "100010100000000001001010100000000001101010000000000000101111010001111",
        "01100010000000001000000000000000000101100001000101010110001011001000100000000010000100011000111000110100", // doesn't work
//       VVVTTTILLLLLLLLLLLLLLLVVVTTTILLLLLLLLLLLLLLL
        "1100000000000001010100000000000000000001011000010001010110100010111000001000000000101111000110000010001101000",
        "10100000000000010110110010001000000000010110001000000001011111000011011010000110101100011000101000111101010001111",
        "00100010000011010111000000000000011100011111001110011111100111000110101111001001001011010100101001100111000100111100011100110111101100111110100110000111100000110000000001001010110000000001011010011011010010111001100111111001001111001111110000110001101011000100110110001010010010111011100010011110100111010110010101001101001000010110101110000000000100110001110111000000000001010000101100100000000001000011111000100111110000011111100000110010010000000000100001101100010001101000101000110001000111001100000000011000100011011011000010111010000100101011000000000111000110010010001000011101001111110111101011110111011101101101110001011101111001100011010100001001010010100111110100100011011100000000100000100111100101011010010100101001000100010111100100011110110010110111111011011010100111001111110101100011010010111101111011010001010000000011000000000100011111000000000101001001100011101110001000000011100100110001101111110111001001010110000110001001101001011001001100000000010111100001000101101000000000101101001101000110011100111001100110011010001110101000000001010001001001101110101100101011010110111110111010111011100000100011110010110101011000011110100111110010000101100101010010010010110011100000000011100110100100011000110000000001000110010010011011001010000000000101010001100101101100001011101100101101100001011101011100000000101101100111010111011010011100101101110101111110100111011011111000110111011111010110001010110010011101101001100011110000110101001011101011010001000000000111001101010010011101101011010010111001001111000000111111110000000000101111111100110101100111110011101111001111111100001101110010000000001010101100110000000000001011001110001101010100011010111001001011111100101101110101100100001100001110000000001000010000010100100011111000011000000000100011001111111101001000011101000000000100000000000000000100001001100011101101000001110110000100001000000000000010000100010000100101100000110101000101111110011000100011101011000101001101100111011001100000000010111100100011001010100011001011101000000000101111001011111101101111101011101001111101001110110011101101111111101100000110001100100000000100110010101100000000001101110111000000000000010000110010001001001100010111011000111100100000000000001000010001000101010110001100011100000100101001101111111010101010100000000000110100101100111111100010011110111001001000011100101010000111001000000000001110101001000011000110001000010100110101100010110110101000101010101001000000001001110011110110000000001011100010000000001110110001000011100001010001000111010000010000000001101010000111000100011111111000010111010010100111011100111101111100100111000100000000010011001001101000000000100001001100000011011100101000010010110011110101001000100001100100000010100001000000001000101000110001010010111100001111011000011011011001101010110110010010010010011000110111110100110011000100000000001111100111100100110000000000000001001011111001101111011110100001010110000011110001000000001001101100110010101100001001111011000111111111000000000101010001000000000110101000001110110001100000100000101010000000000000100001110100010000101000011101010001000111001100000000100110100110000001000010011000011101111000100100010011001010101100011000000000101111011000000000101100000000000000100001111100000111011000100011010000010111000000000000010000100010001011111100011011111000101000010011010010100110000000000001011111101100010011011001101011001101010011011110011000011010001001110110001010100001001101010100011001010011000000000101111101000000000101011001000111000110000001101010010011000110001001010111010101100010001110011101110011011011000110101001010000000010000010000000001111000010111000000000101001000010011111100101111011001101011000100101111100111111001011110110011010110001001010001001101101110110001000000000100101100110100000000000110111111001001001100001100001111101001110010000110100100110100110000000000101110011111010110100011000000000110011001111101001010100101000000100110011100010101001001100001110101001000000000010000010010010011000000111001100100010100010100000000100010100100011101010100110111101011011001101101001000111001111010101000010010110110000010110110011110110011010111110001101110101000000000011111001111011011010000100010000000001111000100110000000000011010010110010111101001100001110001100101111010011000011101011001111010100101111100111111111011001000011001001100000000010011101100000000010011100110011000110010111001110010010010000111000101111110010001011000101001011010101101011010010110110000101001001000000001101001110100000000000110010001011001000000010111101100000010000000000100001100000001010100110110011000000000010010100000000100101011011000000000010001010100101100000000111111111100001000000000011010001000000000010010000000000011000101111010100000000001110000100000000001001011100000000001101000000000000111100111001100000000011000111000011000000000011110110000000000111011000001100000000001011100110001100010101100011111110110011011111001110010010111101000110111111101001110110100110000011100110000000001011110100000000001111100011001001110010100111100101000010100110111001011011100000101010010011111110101110010010100101111100110010001000000001010000101000010000000001101010001111010100001000101000011011000000000000001000010011000101110010001110110100001101000000000000000100001101100001100011000010000010001001111001000000000101000011110010111010011101001000101100111100111000000001110010001001001111001000100100000100111101001110000110110010110100110000000001010010011110101011011000111101101000000000100100010010010100111001001010011110010000101010010100111001001010011110010000100000"
                                            };
    public static void main(String[] args){
        long start = System.currentTimeMillis();
        testParse();
        System.out.println(problemOne());
        System.out.println(problemTwo());
        System.out.println("This run took: "  + (System.currentTimeMillis() - start) +"ms");
    }

    public static void testParse(){
        boolean a = 16 == parseOperatorPacket(exampleStrings[0])[1];
        boolean b = 12 == parseOperatorPacket(exampleStrings[1])[1];
        boolean c = 23 == parseOperatorPacket(exampleStrings[2])[1];
        boolean d = 31 == parseOperatorPacket(exampleStrings[3])[1];
        boolean[] xs = {a, b, c,d};
        for(boolean x: xs){
            if(!x){
                System.out.println("Test b failed!");
                return;
            }
        }
        System.out.println("all test passed");
    }
    
    public static long problemOne(){
        // String longBinaryString = hexToBinary(parseInputToArray().get(0));
        // longBinaryString = longBinaryString.substring(0, longBinaryString.length()-6);
        // exampleStrings[1] doesn't work, the others do
        long[] totals = parseOperatorPacket(exampleStrings[4]);
        System.out.println(Arrays.toString(totals));
        return totals[1];
    }
    
    public static long[] parseOperatorPacket(String binaryString){
        long[] result = new long[3]; // first index length, second versionValue, third result (blank for now)
        long lenType = binaryString.charAt(6) == '1' ? 1:0;
        result[1] += Long.parseLong(binaryString.substring(0, 3), 2); // add the version value to our sum
        long lenInBits = 0;
        long lenInPackets = 0;
        if(lenType == 0){
            lenInBits = Long.parseLong(binaryString.substring(7, 22), 2);   
        } else {
            lenInPackets = Long.parseLong(binaryString.substring(7, 18), 2);
        }
        int j = lenType == 0 ? 22:18;
        while(lenInPackets > 0 || (j < 22 + lenInBits && lenInBits != 0)){
            lenInPackets--;
            if(binaryString.substring(j+3, j+6).equals("100")){ // If we have a literal value
                long[] lit = parseLiteral(binaryString.substring(j));
                j += lit[0]; // Skip over the literal
                result[1] += lit[2]; // Increment our versionValue;
            } else {
                long[] op = parseOperatorPacket(binaryString.substring(j));
                j += op[0]; // skip the entire length of the operator
                result[1] += op[1]; // Add the total versionValue from the nested operator
            }
        } 
        result[0] = j;
        return result;
    }


    // Seems to work
    public static long[] parseLiteral(String binaryString){ 
        // Determines how long a literal is so that we know where the next packet starts
        // Also returns the value of the literal
        // Example : "11110011010110101101001010001111001000010000" should return [28, 43690]  since 
        // It gets split like this : "1111001101011010110100101000 1111001000000000"
        long len = 0;
        long version = Long.parseLong(binaryString.substring(0, 3) , 2);
        StringBuilder sum = new StringBuilder();
        binaryString = binaryString.substring(6); // Cut off version ID and type id, len 6
        len += 6;
        int i = 0;
        while(binaryString.charAt(i) != '0'){
            sum.append(binaryString.substring(i+1, i+5));
            i += 5;
            len += 5;
        }
        sum.append(binaryString.substring(i+1, i+5));
        i += 5;
        len += 5;
        long value = Long.parseLong(sum.toString(), 2);
        long[] result = {len, value, version};
        return result;
    }

    public static long problemTwo(){
        return 0;
    }


    public static String hexToBinary(String hex) {
        return new BigInteger(hex, 16).toString(2);
    }


    public static ArrayList<String> parseInputToArray(){
        try {
            BufferedReader reader = new BufferedReader(new FileReader("input.txt"));
            ArrayList<String> list = new ArrayList<>();
            String line = reader.readLine();
            while(line != null){
                list.add(line);
                line = reader.readLine();
            }
            reader.close();
            return list;
        } catch (Exception e){
            System.out.println("error");
            return null;
        }
    }

}
